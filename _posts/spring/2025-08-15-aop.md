---
title: "ğŸ›  AOP (Aspect Oriented Programming)"
categories:
  - spring
tags:
  - AOP
toc: true
mermaid: true
---

## 1. AOPê°€ ë­”ê°€ìš”? ğŸ¤”

### ì‹¤ìƒí™œ ë¹„ìœ ë¡œ ì´í•´í•˜ê¸°

ì—¬ëŸ¬ë¶„ì´ íšŒì‚¬ CEOë¼ê³  ìƒê°í•´ë³´ì„¸ìš”. í•˜ë£¨ì— ìˆ˜ë§ì€ ì—…ë¬´ê°€ ìˆì§€ë§Œ, ëª¨ë“  ì—…ë¬´ ì „í›„ë¡œ í•´ì•¼ í•  ì¼ë“¤ì´ ìˆìŠµë‹ˆë‹¤.

```mermaid
graph TB
    subgraph "CEOì˜ í•˜ë£¨ (AOP ì ìš© ì „)"
        A1[íšŒì˜ ì¤€ë¹„] --> A2[ë³´ì•ˆ ì²´í¬] --> A3[ì‹œê°„ ê¸°ë¡] --> A4[íšŒì˜ ì§„í–‰] --> A5[ê²°ê³¼ ê¸°ë¡] --> A6[ì •ë¦¬]
        B1[ê³„ì•½ì„œ ê²€í†  ì¤€ë¹„] --> B2[ë³´ì•ˆ ì²´í¬] --> B3[ì‹œê°„ ê¸°ë¡] --> B4[ê³„ì•½ì„œ ê²€í† ] --> B5[ê²°ê³¼ ê¸°ë¡] --> B6[ì •ë¦¬]
        C1[ì˜ì‚¬ê²°ì • ì¤€ë¹„] --> C2[ë³´ì•ˆ ì²´í¬] --> C3[ì‹œê°„ ê¸°ë¡] --> C4[ì˜ì‚¬ê²°ì •] --> C5[ê²°ê³¼ ê¸°ë¡] --> C6[ì •ë¦¬]
    end
    
    style A2 fill:#ffebee
    style A3 fill:#e8f5e8
    style A5 fill:#e3f2fd
    style B2 fill:#ffebee
    style B3 fill:#e8f5e8
    style B5 fill:#e3f2fd
    style C2 fill:#ffebee
    style C3 fill:#e8f5e8
    style C5 fill:#e3f2fd
```

**ë¬¸ì œì **: ë³´ì•ˆ ì²´í¬, ì‹œê°„ ê¸°ë¡, ê²°ê³¼ ê¸°ë¡ ë“±ì´ ëª¨ë“  ì—…ë¬´ì— ë°˜ë³µë¨ ğŸ˜µ

### AOP ì ìš© í›„

```mermaid
graph TB
    subgraph "CEOì˜ í•˜ë£¨ (AOP ì ìš© í›„)"
        D[ë¹„ì„œ/ì‹œìŠ¤í…œ] -.-> E1[íšŒì˜ ì§„í–‰]
        D -.-> E2[ê³„ì•½ì„œ ê²€í† ]
        D -.-> E3[ì˜ì‚¬ê²°ì •]
        
        F[ë³´ì•ˆ ë‹´ë‹¹ì] -.-> D
        G[ì‹œê°„ ê´€ë¦¬ì] -.-> D
        H[ê¸°ë¡ ë‹´ë‹¹ì] -.-> D
    end
    
    style D fill:#e8f5e8
    style F fill:#ffebee
    style G fill:#e3f2fd
    style H fill:#fff3e0
```

**í•´ê²°ì±…**: ë¶€ê°€ ì—…ë¬´ë“¤ì„ ì „ë‹´ ì‹œìŠ¤í…œì´ ìë™ìœ¼ë¡œ ì²˜ë¦¬! ğŸ¯

## 2. í”„ë¡ì‹œ íŒ¨í„´ ì´í•´í•˜ê¸° ğŸ•µï¸â€â™‚ï¸

### í”„ë¡ì‹œë€?

í”„ë¡ì‹œëŠ” **ëŒ€ë¦¬ì¸** ì—­í• ì„ í•©ë‹ˆë‹¤. ì‹¤ì œ ê°ì²´ ëŒ€ì‹  ìš”ì²­ì„ ë°›ì•„ì„œ ë¶€ê°€ ì‘ì—…ì„ ìˆ˜í–‰í•œ í›„ ì‹¤ì œ ê°ì²´ì—ê²Œ ì „ë‹¬í•©ë‹ˆë‹¤.

```mermaid
sequenceDiagram
    participant Client as í´ë¼ì´ì–¸íŠ¸
    participant Proxy as í”„ë¡ì‹œ ê°ì²´
    participant Target as ì‹¤ì œ ê°ì²´
    
    Client->>Proxy: ë©”ì„œë“œ í˜¸ì¶œ
    Note over Proxy: ë¶€ê°€ ê¸°ëŠ¥ ì‹¤í–‰ (ë¡œê¹…, ë³´ì•ˆ ë“±)
    Proxy->>Target: ì‹¤ì œ ë©”ì„œë“œ í˜¸ì¶œ
    Target-->>Proxy: ê²°ê³¼ ë°˜í™˜
    Note over Proxy: ë¶€ê°€ ê¸°ëŠ¥ ì‹¤í–‰ (ê²°ê³¼ ë¡œê¹… ë“±)
    Proxy-->>Client: ìµœì¢… ê²°ê³¼ ë°˜í™˜
```

### í”„ë¡ì‹œê°€ ì—†ë‹¤ë©´? ğŸ˜°

```java
// ğŸ˜° ëª¨ë“  ë©”ì„œë“œì— ì¤‘ë³µ ì½”ë“œê°€ ë“¤ì–´ê°
@Service
public class UserService {
    
    public User findUser(Long id) {
        // ë¡œê¹…
        System.out.println("ì‚¬ìš©ì ì¡°íšŒ ì‹œì‘");
        long startTime = System.currentTimeMillis();
        
        // ë³´ì•ˆ ì²´í¬
        if (!SecurityContext.getCurrentUser().hasPermission("READ_USER")) {
            throw new SecurityException("ê¶Œí•œ ì—†ìŒ");
        }
        
        // íŠ¸ëœì­ì…˜ ì‹œì‘
        TransactionManager.begin();
        
        try {
            // ğŸ¯ ì‹¤ì œ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ (ì´ê²ƒë§Œ í•˜ê³  ì‹¶ì—ˆëŠ”ë°...)
            User user = userRepository.findById(id);
            
            // íŠ¸ëœì­ì…˜ ì»¤ë°‹
            TransactionManager.commit();
            
            // ì„±ëŠ¥ ë¡œê¹…
            long endTime = System.currentTimeMillis();
            System.out.println("ì‹¤í–‰ ì‹œê°„: " + (endTime - startTime) + "ms");
            
            return user;
        } catch (Exception e) {
            TransactionManager.rollback();
            throw e;
        }
    }
    
    public void saveUser(User user) {
        // ğŸ˜± ë˜ ê°™ì€ ì½”ë“œ ë°˜ë³µ...
        System.out.println("ì‚¬ìš©ì ì €ì¥ ì‹œì‘");
        // ... ì¤‘ë³µ ì½”ë“œë“¤
    }
}
```

## 3. JDK Dynamic Proxy ğŸš€

### íŠ¹ì§•
- **ì¸í„°í˜ì´ìŠ¤ ê¸°ë°˜**: ë°˜ë“œì‹œ ì¸í„°í˜ì´ìŠ¤ê°€ ìˆì–´ì•¼ í•¨
- **JDK ë‚´ì¥**: ì¶”ê°€ ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¶ˆí•„ìš”
- **ë¦¬í”Œë ‰ì…˜ ì‚¬ìš©**: `InvocationHandler` í™œìš©

### êµ¬ì¡°

```mermaid
graph TB
    subgraph "JDK Dynamic Proxy êµ¬ì¡°"
        A[<<interface>> UserService] --> B[UserServiceImpl]
        A --> C[JDK Proxy]
        C -.-> B
        D[InvocationHandler] --> C
    end
    
    style A fill:#e3f2fd
    style C fill:#ffebee
    style D fill:#e8f5e8
```

### ì‹¤ìŠµ ì˜ˆì œ

#### 1ë‹¨ê³„: ì¸í„°í˜ì´ìŠ¤ì™€ êµ¬í˜„ì²´ ë§Œë“¤ê¸°

```java
// ğŸ“‹ ì¸í„°í˜ì´ìŠ¤ (í•„ìˆ˜!)
public interface UserService {
    User findUser(Long id);
    void saveUser(User user);
}

// ğŸ—ï¸ ì‹¤ì œ êµ¬í˜„ì²´
public class UserServiceImpl implements UserService {
    
    @Override
    public User findUser(Long id) {
        // ìˆœìˆ˜í•œ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ë§Œ!
        System.out.println("DBì—ì„œ ì‚¬ìš©ì ì¡°íšŒ: " + id);
        return new User(id, "í™ê¸¸ë™");
    }
    
    @Override
    public void saveUser(User user) {
        System.out.println("DBì— ì‚¬ìš©ì ì €ì¥: " + user.getName());
    }
}

// ğŸ“¦ ê°„ë‹¨í•œ User í´ë˜ìŠ¤
public class User {
    private Long id;
    private String name;
    
    public User(Long id, String name) {
        this.id = id;
        this.name = name;
    }
    
    // getter, setter, toString...
    public Long getId() { return id; }
    public String getName() { return name; }
    public String toString() { return "User{id=" + id + ", name='" + name + "'}"; }
}
```

#### 2ë‹¨ê³„: InvocationHandler êµ¬í˜„

```java
import java.lang.reflect.InvocationHandler;
import java.lang.reflect.Method;

public class LoggingInvocationHandler implements InvocationHandler {
    private final Object target; // ì‹¤ì œ ê°ì²´
    
    public LoggingInvocationHandler(Object target) {
        this.target = target;
    }
    
    @Override
    public Object invoke(Object proxy, Method method, Object[] args) throws Throwable {
        // ğŸ¯ Before: ë©”ì„œë“œ ì‹¤í–‰ ì „
        System.out.println("ğŸš€ [JDK Proxy] " + method.getName() + " ë©”ì„œë“œ ì‹œì‘");
        long startTime = System.currentTimeMillis();
        
        try {
            // ì‹¤ì œ ë©”ì„œë“œ ì‹¤í–‰
            Object result = method.invoke(target, args);
            
            // ğŸ¯ After: ë©”ì„œë“œ ì‹¤í–‰ í›„ (ì„±ê³µ)
            long endTime = System.currentTimeMillis();
            System.out.println("âœ… [JDK Proxy] " + method.getName() + " ì„±ê³µ (ì‹¤í–‰ì‹œê°„: " + (endTime - startTime) + "ms)");
            
            return result;
        } catch (Exception e) {
            // ğŸ¯ After: ë©”ì„œë“œ ì‹¤í–‰ í›„ (ì‹¤íŒ¨)
            System.out.println("âŒ [JDK Proxy] " + method.getName() + " ì‹¤íŒ¨: " + e.getMessage());
            throw e;
        }
    }
}
```

#### 3ë‹¨ê³„: í”„ë¡ì‹œ ìƒì„± ë° ì‹¤í–‰

```java
import java.lang.reflect.Proxy;

public class JdkProxyExample {
    public static void main(String[] args) {
        // 1. ì‹¤ì œ ê°ì²´ ìƒì„±
        UserService target = new UserServiceImpl();
        
        // 2. í”„ë¡ì‹œ ìƒì„±
        UserService proxy = (UserService) Proxy.newProxyInstance(
            UserService.class.getClassLoader(),           // í´ë˜ìŠ¤ë¡œë”
            new Class[]{UserService.class},               // ì¸í„°í˜ì´ìŠ¤ë“¤
            new LoggingInvocationHandler(target)          // í•¸ë“¤ëŸ¬
        );
        
        // 3. í”„ë¡ì‹œë¥¼ í†µí•œ ë©”ì„œë“œ í˜¸ì¶œ
        System.out.println("=== JDK Dynamic Proxy í…ŒìŠ¤íŠ¸ ===");
        
        User user = proxy.findUser(1L);
        System.out.println("ì¡°íšŒ ê²°ê³¼: " + user);
        
        System.out.println();
        
        proxy.saveUser(new User(2L, "ê¹€ì² ìˆ˜"));
        
        // 4. í”„ë¡ì‹œ íƒ€ì… í™•ì¸
        System.out.println("\n=== íƒ€ì… í™•ì¸ ===");
        System.out.println("í”„ë¡ì‹œ í´ë˜ìŠ¤: " + proxy.getClass().getName());
        System.out.println("UserService ì¸í„°í˜ì´ìŠ¤? " + (proxy instanceof UserService));
        System.out.println("UserServiceImpl í´ë˜ìŠ¤? " + (proxy instanceof UserServiceImpl));
    }
}
```

**ì‹¤í–‰ ê²°ê³¼:**
```
=== JDK Dynamic Proxy í…ŒìŠ¤íŠ¸ ===
ğŸš€ [JDK Proxy] findUser ë©”ì„œë“œ ì‹œì‘
DBì—ì„œ ì‚¬ìš©ì ì¡°íšŒ: 1
âœ… [JDK Proxy] findUser ì„±ê³µ (ì‹¤í–‰ì‹œê°„: 15ms)
ì¡°íšŒ ê²°ê³¼: User{id=1, name='í™ê¸¸ë™'}

ğŸš€ [JDK Proxy] saveUser ë©”ì„œë“œ ì‹œì‘
DBì— ì‚¬ìš©ì ì €ì¥: ê¹€ì² ìˆ˜
âœ… [JDK Proxy] saveUser ì„±ê³µ (ì‹¤í–‰ì‹œê°„: 8ms)

=== íƒ€ì… í™•ì¸ ===
í”„ë¡ì‹œ í´ë˜ìŠ¤: com.sun.proxy.$Proxy0
UserService ì¸í„°í˜ì´ìŠ¤? true
UserServiceImpl í´ë˜ìŠ¤? false
```

## 4. CGLIB Proxy âš¡

### íŠ¹ì§•
- **í´ë˜ìŠ¤ ê¸°ë°˜**: ì¸í„°í˜ì´ìŠ¤ ì—†ì´ë„ í”„ë¡ì‹œ ìƒì„± ê°€ëŠ¥
- **ìƒì† ë°©ì‹**: ëŒ€ìƒ í´ë˜ìŠ¤ë¥¼ ìƒì†ë°›ì•„ í”„ë¡ì‹œ ìƒì„±
- **ë°”ì´íŠ¸ì½”ë“œ ì¡°ì‘**: ë” ë¹ ë¥¸ ì„±ëŠ¥

### êµ¬ì¡°

```mermaid
graph TB
    subgraph "CGLIB Proxy êµ¬ì¡°"
        A[OrderService] --> B[CGLIB Proxy]
        B -.-> A
        C[MethodInterceptor] --> B
    end
    
    style A fill:#e8f5e8
    style B fill:#ffebee
    style C fill:#e3f2fd
```

### ì‹¤ìŠµ ì˜ˆì œ

#### 1ë‹¨ê³„: êµ¬ì²´ í´ë˜ìŠ¤ ë§Œë“¤ê¸° (ì¸í„°í˜ì´ìŠ¤ ì—†ìŒ!)

```java
// ğŸ—ï¸ êµ¬ì²´ í´ë˜ìŠ¤ë§Œ ìˆì–´ë„ OK!
public class OrderService {
    
    public void createOrder(String orderInfo) {
        System.out.println("ì£¼ë¬¸ ìƒì„±: " + orderInfo);
    }
    
    public String getOrderStatus(String orderId) {
        System.out.println("ì£¼ë¬¸ ìƒíƒœ ì¡°íšŒ: " + orderId);
        return "ì£¼ë¬¸ ìƒíƒœ: ì²˜ë¦¬ì¤‘";
    }
}
```

#### 2ë‹¨ê³„: MethodInterceptor êµ¬í˜„

```java
import org.springframework.cglib.proxy.MethodInterceptor;
import org.springframework.cglib.proxy.MethodProxy;
import java.lang.reflect.Method;

public class LoggingMethodInterceptor implements MethodInterceptor {
    
    @Override
    public Object intercept(Object obj, Method method, Object[] args, MethodProxy proxy) throws Throwable {
        // ğŸ¯ Before: ë©”ì„œë“œ ì‹¤í–‰ ì „
        System.out.println("âš¡ [CGLIB] " + method.getName() + " ë©”ì„œë“œ ì‹œì‘");
        long startTime = System.currentTimeMillis();
        
        try {
            // ì‹¤ì œ ë©”ì„œë“œ ì‹¤í–‰ (ë” íš¨ìœ¨ì ì¸ ë°©ë²•)
            Object result = proxy.invokeSuper(obj, args);
            
            // ğŸ¯ After: ë©”ì„œë“œ ì‹¤í–‰ í›„ (ì„±ê³µ)
            long endTime = System.currentTimeMillis();
            System.out.println("âœ… [CGLIB] " + method.getName() + " ì„±ê³µ (ì‹¤í–‰ì‹œê°„: " + (endTime - startTime) + "ms)");
            
            return result;
        } catch (Exception e) {
            // ğŸ¯ After: ë©”ì„œë“œ ì‹¤í–‰ í›„ (ì‹¤íŒ¨)
            System.out.println("âŒ [CGLIB] " + method.getName() + " ì‹¤íŒ¨: " + e.getMessage());
            throw e;
        }
    }
}
```

#### 3ë‹¨ê³„: ì˜ì¡´ì„± ì¶”ê°€ (build.gradle)

```gradle
dependencies {
    implementation 'org.springframework.boot:spring-boot-starter'
}
```

#### 4ë‹¨ê³„: í”„ë¡ì‹œ ìƒì„± ë° ì‹¤í–‰

```java
import org.springframework.cglib.proxy.Enhancer;

public class CglibProxyExample {
    public static void main(String[] args) {
        // 1. CGLIB Enhancer ìƒì„±
        Enhancer enhancer = new Enhancer();
        enhancer.setSuperclass(OrderService.class);           // ìƒì†í•  í´ë˜ìŠ¤
        enhancer.setCallback(new LoggingMethodInterceptor()); // ì¸í„°ì…‰í„°
        
        // 2. í”„ë¡ì‹œ ìƒì„±
        OrderService proxy = (OrderService) enhancer.create();
        
        // 3. í”„ë¡ì‹œë¥¼ í†µí•œ ë©”ì„œë“œ í˜¸ì¶œ
        System.out.println("=== CGLIB Proxy í…ŒìŠ¤íŠ¸ ===");
        
        proxy.createOrder("ë§¥ë¶ í”„ë¡œ êµ¬ë§¤");
        System.out.println();
        
        String status = proxy.getOrderStatus("ORDER-001");
        System.out.println("ê²°ê³¼: " + status);
        
        // 4. í”„ë¡ì‹œ íƒ€ì… í™•ì¸
        System.out.println("\n=== íƒ€ì… í™•ì¸ ===");
        System.out.println("í”„ë¡ì‹œ í´ë˜ìŠ¤: " + proxy.getClass().getName());
        System.out.println("OrderService í´ë˜ìŠ¤? " + (proxy instanceof OrderService));
    }
}
```

**ì‹¤í–‰ ê²°ê³¼:**
```
=== CGLIB Proxy í…ŒìŠ¤íŠ¸ ===
âš¡ [CGLIB] createOrder ë©”ì„œë“œ ì‹œì‘
ì£¼ë¬¸ ìƒì„±: ë§¥ë¶ í”„ë¡œ êµ¬ë§¤
âœ… [CGLIB] createOrder ì„±ê³µ (ì‹¤í–‰ì‹œê°„: 12ms)

âš¡ [CGLIB] getOrderStatus ë©”ì„œë“œ ì‹œì‘
ì£¼ë¬¸ ìƒíƒœ ì¡°íšŒ: ORDER-001
âœ… [CGLIB] getOrderStatus ì„±ê³µ (ì‹¤í–‰ì‹œê°„: 5ms)
ê²°ê³¼: ì£¼ë¬¸ ìƒíƒœ: ì²˜ë¦¬ì¤‘

=== íƒ€ì… í™•ì¸ ===
í”„ë¡ì‹œ í´ë˜ìŠ¤: com.example.OrderService$$EnhancerByCGLIB$$12345678
OrderService í´ë˜ìŠ¤? true
```

## 5. ë‘ ë°©ì‹ ë¹„êµ âš–ï¸

### ë¹„êµí‘œ

| íŠ¹ì§• | JDK Dynamic Proxy | CGLIB Proxy |
|------|-------------------|-------------|
| **í•„ìš” ì¡°ê±´** | ì¸í„°í˜ì´ìŠ¤ í•„ìˆ˜ âœ… | êµ¬ì²´ í´ë˜ìŠ¤ë§Œ ìˆì–´ë„ OK âœ… |
| **ìƒì„± ë°©ì‹** | ì¸í„°í˜ì´ìŠ¤ êµ¬í˜„ | í´ë˜ìŠ¤ ìƒì† |
| **ì„±ëŠ¥** | ëŠë¦¼ (ë¦¬í”Œë ‰ì…˜) | ë¹ ë¦„ (ë°”ì´íŠ¸ì½”ë“œ) |
| **ì˜ì¡´ì„±** | JDK ë‚´ì¥ | ì™¸ë¶€ ë¼ì´ë¸ŒëŸ¬ë¦¬ |
| **íƒ€ì… ìºìŠ¤íŒ…** | ì¸í„°í˜ì´ìŠ¤ë§Œ ê°€ëŠ¥ | êµ¬ì²´ í´ë˜ìŠ¤ ê°€ëŠ¥ |
| **final ì œí•œ** | ì—†ìŒ | final í´ë˜ìŠ¤/ë©”ì„œë“œ ë¶ˆê°€ |

### ì„ íƒ ê¸°ì¤€

```mermaid
flowchart TD
    A[í”„ë¡ì‹œ ìƒì„± í•„ìš”] --> B{ì¸í„°í˜ì´ìŠ¤ ìˆìŒ?}
    B -->|Yes| C{ì„±ëŠ¥ì´ ì¤‘ìš”?}
    B -->|No| D[CGLIB ì„ íƒ]
    C -->|Yes| E[CGLIB ê¶Œì¥]
    C -->|No| F[JDK Proxy ê¶Œì¥]
    
    G[Spring Boot] --> H[ê¸°ë³¸ì ìœ¼ë¡œ CGLIB ì‚¬ìš©]
    
    style D fill:#e8f5e8
    style E fill:#e8f5e8
    style F fill:#e3f2fd
    style H fill:#fff3e0
```

## 6. Spring AOP ì‹¤ìŠµ ğŸŒ±

### í”„ë¡œì íŠ¸ ì„¤ì •

#### build.gradle
```groovy
plugins {
	id 'java'
	id 'org.springframework.boot' version '3.5.4'
	id 'io.spring.dependency-management' version '1.1.7'
}

dependencies {
    implementation 'org.springframework.boot:spring-boot-starter-web'
    implementation 'org.springframework.boot:spring-boot-starter-aop'

    compileOnly 'org.projectlombok:lombok'
    annotationProcessor 'org.projectlombok:lombok'

    testImplementation 'org.springframework.boot:spring-boot-starter-test'
    testRuntimeOnly 'org.junit.platform:junit-platform-launcher'

    testCompileOnly 'org.projectlombok:lombok'
    testAnnotationProcessor 'org.projectlombok:lombok'
}
```

#### application.yml
```yaml
spring:
  aop:
    proxy-target-class: true  # CGLIB ì‚¬ìš© ê°•ì œ
    
logging:
  level:
    com.example: DEBUG
```

### ê¸°ë³¸ ì„¤ì •

```java
// ğŸ“ Application.java
@SpringBootApplication
@EnableAspectJAutoProxy  // AOP í™œì„±í™”
public class AopDemoApplication {
    public static void main(String[] args) {
        SpringApplication.run(AopDemoApplication.class, args);
    }
}
```

## 7. ê³µí†µ ê¸°ëŠ¥ êµ¬í˜„ ğŸ”§

### 1. ë¡œê¹… Aspect

```java
@Aspect
@Component
@Slf4j
public class LoggingAspect {
    
    // ğŸ¯ ëª¨ë“  Service í´ë˜ìŠ¤ì˜ public ë©”ì„œë“œì— ì ìš©
    @Pointcut("execution(public * com.example.service.*.*(..))")
    public void serviceLayer() {}
    
    @Before("serviceLayer()")
    public void logBefore(JoinPoint joinPoint) {
        String methodName = joinPoint.getSignature().getName();
        String className = joinPoint.getTarget().getClass().getSimpleName();
        Object[] args = joinPoint.getArgs();
        
        log.info("ğŸš€ [{}] {} ì‹œì‘ - íŒŒë¼ë¯¸í„°: {}", className, methodName, Arrays.toString(args));
    }
    
    @AfterReturning(value = "serviceLayer()", returning = "result")
    public void logAfterReturning(JoinPoint joinPoint, Object result) {
        String methodName = joinPoint.getSignature().getName();
        String className = joinPoint.getTarget().getClass().getSimpleName();
        
        log.info("âœ… [{}] {} ì„±ê³µ - ê²°ê³¼: {}", className, methodName, result);
    }
    
    @AfterThrowing(value = "serviceLayer()", throwing = "ex")
    public void logAfterThrowing(JoinPoint joinPoint, Exception ex) {
        String methodName = joinPoint.getSignature().getName();
        String className = joinPoint.getTarget().getClass().getSimpleName();
        
        log.error("âŒ [{}] {} ì‹¤íŒ¨ - ì—ëŸ¬: {}", className, methodName, ex.getMessage());
    }
}
```

### 2. ì„±ëŠ¥ ì¸¡ì • Aspect

```java
@Aspect
@Component
@Slf4j
public class PerformanceAspect {
    
    // ğŸ¯ @PerformanceMonitor ì–´ë…¸í…Œì´ì…˜ì´ ë¶™ì€ ë©”ì„œë“œì— ì ìš©
    @Around("@annotation(PerformanceMonitor)")
    public Object measureExecutionTime(ProceedingJoinPoint joinPoint) throws Throwable {
        String methodName = joinPoint.getSignature().getName();
        String className = joinPoint.getTarget().getClass().getSimpleName();
        
        long startTime = System.currentTimeMillis();
        
        try {
            Object result = joinPoint.proceed();
            
            long endTime = System.currentTimeMillis();
            long executionTime = endTime - startTime;
            
            // ì„±ëŠ¥ ì„ê³„ì¹˜ ì²´í¬ (100ms)
            if (executionTime > 100) {
                log.warn("ğŸŒ [{}] {} ëŠë¦° ì‹¤í–‰ ê°ì§€! {}ms", className, methodName, executionTime);
            } else {
                log.info("âš¡ [{}] {} ì‹¤í–‰ ì™„ë£Œ: {}ms", className, methodName, executionTime);
            }
            
            return result;
        } catch (Exception e) {
            long endTime = System.currentTimeMillis();
            log.error("ğŸ’¥ [{}] {} ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜ ({}ms): {}", className, methodName, 
                     endTime - startTime, e.getMessage());
            throw e;
        }
    }
}

// ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§ ì–´ë…¸í…Œì´ì…˜
@Target(ElementType.METHOD)
@Retention(RetentionPolicy.RUNTIME)
public @interface PerformanceMonitor {
}
```

### 3. ë³´ì•ˆ Aspect

```java
@Aspect
@Component
@Slf4j
public class SecurityAspect {
    
    @Before("@annotation(RequireAuth)")
    public void checkAuthentication(JoinPoint joinPoint, RequireAuth requireAuth) {
        // í˜„ì¬ ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸° (ì‹¤ì œë¡œëŠ” SecurityContextì—ì„œ)
        String currentUser = getCurrentUser();
        
        if (currentUser == null) {
            log.error("ğŸ”’ ì¸ì¦ë˜ì§€ ì•Šì€ ì‚¬ìš©ìì˜ ì ‘ê·¼ ì‹œë„: {}", 
                     joinPoint.getSignature().getName());
            throw new SecurityException("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
        }
        
        // ê¶Œí•œ ì²´í¬
        String requiredRole = requireAuth.role();
        if (!hasRole(currentUser, requiredRole)) {
            log.error("ğŸš« ê¶Œí•œ ì—†ëŠ” ì ‘ê·¼ ì‹œë„: ì‚¬ìš©ì={}, í•„ìš”ê¶Œí•œ={}", currentUser, requiredRole);
            throw new SecurityException("ê¶Œí•œì´ ë¶€ì¡±í•©ë‹ˆë‹¤. í•„ìš” ê¶Œí•œ: " + requiredRole);
        }
        
        log.info("ğŸ”“ ë³´ì•ˆ ê²€ì¦ í†µê³¼: ì‚¬ìš©ì={}, ë©”ì„œë“œ={}", currentUser, 
                joinPoint.getSignature().getName());
    }
    
    private String getCurrentUser() {
        // ì‹¤ì œë¡œëŠ” SecurityContextHolder.getContext().getAuthentication()
        return "testUser"; // í…ŒìŠ¤íŠ¸ìš©
    }
    
    private boolean hasRole(String user, String role) {
        // ì‹¤ì œë¡œëŠ” DBë‚˜ ìºì‹œì—ì„œ ê¶Œí•œ í™•ì¸
        return "ADMIN".equals(role) && "testUser".equals(user);
    }
}

// ë³´ì•ˆ ì–´ë…¸í…Œì´ì…˜
@Target(ElementType.METHOD)
@Retention(RetentionPolicy.RUNTIME)
public @interface RequireAuth {
    String role() default "USER";
}
```

## 8. ì¢…í•© ì‹¤ìŠµ ğŸ¯

### ë¹„ì¦ˆë‹ˆìŠ¤ ì„œë¹„ìŠ¤ í´ë˜ìŠ¤

```java
@Service
public class ProductService {
    
    @PerformanceMonitor
    @RequireAuth(role = "USER")
    public Product findProduct(Long productId) {
        log.info("ìƒí’ˆ ì¡°íšŒ ë¡œì§ ì‹¤í–‰");
        
        // ì˜ë„ì ìœ¼ë¡œ ì§€ì—° ì‹œë®¬ë ˆì´ì…˜
        try {
            Thread.sleep(50);
        } catch (InterruptedException e) {
            Thread.currentThread().interrupt();
        }
        
        return new Product(productId, "ë§¥ë¶ í”„ë¡œ", new BigDecimal("2500000"));
    }
    
    @PerformanceMonitor
    @RequireAuth(role = "ADMIN")
    public void createProduct(Product product) {
        log.info("ìƒí’ˆ ìƒì„± ë¡œì§ ì‹¤í–‰");
        
        // ì˜ë„ì ìœ¼ë¡œ ëŠë¦° ì‘ì—… ì‹œë®¬ë ˆì´ì…˜
        try {
            Thread.sleep(150);
        } catch (InterruptedException e) {
            Thread.currentThread().interrupt();
        }
        
        log.info("ìƒí’ˆ ìƒì„± ì™„ë£Œ: {}", product.getName());
    }
    
    public void deleteProduct(Long productId) {
        log.info("ìƒí’ˆ ì‚­ì œ ë¡œì§ ì‹¤í–‰: {}", productId);
        
        // ì˜ˆì™¸ ë°œìƒ ì‹œë®¬ë ˆì´ì…˜
        if (productId == 999L) {
            throw new IllegalArgumentException("ì‚­ì œí•  ìˆ˜ ì—†ëŠ” ìƒí’ˆì…ë‹ˆë‹¤.");
        }
    }
}

// Product ì—”í‹°í‹°
public class Product {
    private Long id;
    private String name;
    private BigDecimal price;
    
    public Product(Long id, String name, BigDecimal price) {
        this.id = id;
        this.name = name;
        this.price = price;
    }
    
    // getter, setter, toString
    public Long getId() { return id; }
    public String getName() { return name; }
    public BigDecimal getPrice() { return price; }
    
    @Override
    public String toString() {
        return "Product{id=" + id + ", name='" + name + "', price=" + price + "}";
    }
}
```

### í…ŒìŠ¤íŠ¸ ì»¨íŠ¸ë¡¤ëŸ¬

```java
@RestController
@RequestMapping("/api")
public class TestController {
    
    @Autowired
    private ProductService productService;
    
    @GetMapping("/products/{id}")
    public ResponseEntity<Product> getProduct(@PathVariable Long id) {
        Product product = productService.findProduct(id);
        return ResponseEntity.ok(product);
    }
    
    @PostMapping("/products")
    public ResponseEntity<String> createProduct(@RequestBody Product product) {
        productService.createProduct(product);
        return ResponseEntity.ok("ìƒí’ˆì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.");
    }
    
    @DeleteMapping("/products/{id}")
    public ResponseEntity<String> deleteProduct(@PathVariable Long id) {
        productService.deleteProduct(id);
        return ResponseEntity.ok("ìƒí’ˆì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
    }
}
```

### ì‹¤í–‰ ê²°ê³¼ í™•ì¸

```java
@Component
@Slf4j
public class AopTestRunner implements CommandLineRunner {
    
    @Autowired
    private ProductService productService;
    
    @Override
    public void run(String... args) {
        log.info("=== AOP ì¢…í•© í…ŒìŠ¤íŠ¸ ì‹œì‘ ===");
        
        try {
            // 1. ì •ìƒì ì¸ ìƒí’ˆ ì¡°íšŒ (ë¹ ë¥¸ ì‹¤í–‰)
            log.info("\n--- í…ŒìŠ¤íŠ¸ 1: ìƒí’ˆ ì¡°íšŒ ---");
            Product product = productService.findProduct(1L);
            
            // 2. ê´€ë¦¬ì ê¶Œí•œì´ í•„ìš”í•œ ìƒí’ˆ ìƒì„± (ëŠë¦° ì‹¤í–‰)
            log.info("\n--- í…ŒìŠ¤íŠ¸ 2: ìƒí’ˆ ìƒì„± ---");
            productService.createProduct(new Product(2L, "ì•„ì´íŒ¨ë“œ", new BigDecimal("800000")));
            
            // 3. ì˜ˆì™¸ ë°œìƒ ì¼€ì´ìŠ¤
            log.info("\n--- í…ŒìŠ¤íŠ¸ 3: ì˜ˆì™¸ ë°œìƒ ---");
            productService.deleteProduct(999L);
            
        } catch (Exception e) {
            log.info("ì˜ˆìƒëœ ì˜ˆì™¸ ë°œìƒ: {}", e.getMessage());
        }
        
        log.info("=== AOP ì¢…í•© í…ŒìŠ¤íŠ¸ ì™„ë£Œ ===");
    }
}
```

**ì‹¤í–‰ ê²°ê³¼ ì˜ˆì‹œ:**

```text
=== AOP ì¢…í•© í…ŒìŠ¤íŠ¸ ì‹œì‘ ===

--- í…ŒìŠ¤íŠ¸ 1: ìƒí’ˆ ì¡°íšŒ ---
ğŸ”“ ë³´ì•ˆ ê²€ì¦ í†µê³¼: ì‚¬ìš©ì=testUser, ë©”ì„œë“œ=findProduct
ğŸš€ [ProductService] findProduct ì‹œì‘ - íŒŒë¼ë¯¸í„°: [1]
ìƒí’ˆ ì¡°íšŒ ë¡œì§ ì‹¤í–‰
âš¡ [ProductService] findProduct ì‹¤í–‰ ì™„ë£Œ: 52ms
âœ… [ProductService] findProduct ì„±ê³µ - ê²°ê³¼: Product{id=1, name='ë§¥ë¶ í”„ë¡œ', price=2500000}

--- í…ŒìŠ¤íŠ¸ 2: ìƒí’ˆ ìƒì„± ---
ğŸ”“ ë³´ì•ˆ ê²€ì¦ í†µê³¼: ì‚¬ìš©ì=testUser, ë©”ì„œë“œ=createProduct
ğŸš€ [ProductService] createProduct ì‹œì‘ - íŒŒë¼ë¯¸í„°: [Product{id=2, name='ì•„ì´íŒ¨ë“œ', price=800000}]
ìƒí’ˆ ìƒì„± ë¡œì§ ì‹¤í–‰
ìƒí’ˆ ìƒì„± ì™„ë£Œ: ì•„ì´íŒ¨ë“œ
ğŸŒ [ProductService] createProduct ëŠë¦° ì‹¤í–‰ ê°ì§€! 152ms
âœ… [ProductService] createProduct ì„±ê³µ - ê²°ê³¼: null

--- í…ŒìŠ¤íŠ¸ 3: ì˜ˆì™¸ ë°œìƒ ---
ğŸš€ [ProductService] deleteProduct ì‹œì‘ - íŒŒë¼ë¯¸í„°: [999]
ìƒí’ˆ ì‚­ì œ ë¡œì§ ì‹¤í–‰: 999
âŒ [ProductService] deleteProduct ì‹¤íŒ¨ - ì—ëŸ¬: ì‚­ì œí•  ìˆ˜ ì—†ëŠ” ìƒí’ˆì…ë‹ˆë‹¤.
ì˜ˆìƒëœ ì˜ˆì™¸ ë°œìƒ: ì‚­ì œí•  ìˆ˜ ì—†ëŠ” ìƒí’ˆì…ë‹ˆë‹¤.

=== AOP ì¢…í•© í…ŒìŠ¤íŠ¸ ì™„ë£Œ ===
```

# ğŸ’¸ @Transactionalì´ ì•ˆ ê±¸ë¦¬ëŠ” 4ê°€ì§€ ì¼€ì´ìŠ¤

## ğŸ¤” Spring Boot vs ìˆ˜ë™ AOP ì„¤ì • ì°¨ì´ì 

### Spring Boot (ìë™ ì„¤ì •)
```java
@SpringBootApplication  // ì´ê²ƒë§Œìœ¼ë¡œ @Transactional ë™ì‘!
public class Application {
    public static void main(String[] args) {
        SpringApplication.run(Application.class, args);
    }
}
```

### ìˆ˜ë™ AOP ì„¤ì • (Spring Boot ì•„ë‹ ë•Œ)
```java
@Configuration
@EnableTransactionManagement  // ìˆ˜ë™ìœ¼ë¡œ ì¶”ê°€í•´ì•¼ í•¨
@EnableAspectJAutoProxy
public class Config {
    // íŠ¸ëœì­ì…˜ ë§¤ë‹ˆì € ë“± ì¶”ê°€ ì„¤ì • í•„ìš”
}
```

## ğŸ› ï¸ í”„ë¡œì íŠ¸ ì„¤ì •

### build.gradle
```gradle
plugins {
    id 'java'
    id 'org.springframework.boot' version '3.5.4'
    id 'io.spring.dependency-management' version '1.1.7'
}

dependencies {
    implementation 'org.springframework.boot:spring-boot-starter-data-jpa'
    runtimeOnly 'com.h2database:h2'
    
    compileOnly 'org.projectlombok:lombok'
    annotationProcessor 'org.projectlombok:lombok'
}
```

### application.yml
```yaml
spring:
  datasource:
    url: jdbc:h2:mem:testdb
    driver-class-name: org.h2.Driver
  jpa:
    open-in-view: false
    show-sql: true
    hibernate:
      ddl-auto: create-drop
    
logging:
  level:
    org.springframework.transaction: DEBUG  # íŠ¸ëœì­ì…˜ ë¡œê·¸ í™•ì¸
```

## ğŸ“‹ ê¸°ë³¸ ì½”ë“œ

### User ì—”í‹°í‹°
```java
@Entity
@Getter @Setter @NoArgsConstructor
public class User {
    @Id @GeneratedValue
    private Long id;
    private String name;
    private String email;
    
    public User(String name, String email) {
        this.name = name;
        this.email = email;
    }
}
```

### UserRepository
```java
@Repository
public interface UserRepository extends JpaRepository<User, Long> {
}
```

---

## âŒ ì¼€ì´ìŠ¤ 1: í”„ë¡ì‹œ ì™¸ë¶€ í˜¸ì¶œ (Self-Invocation)

### ë¬¸ì œê°€ ë˜ëŠ” ì½”ë“œ
```java
@Slf4j
@RequiredArgsConstructor
@Service
public class Case1Service {

    private final UserRepository userRepository;

    public void selfInvocationExample() {
        this.saveUserInternal("user1", "user1@test.com");
    }

    @Transactional
    public void saveUserInternal(String name, String email) {
        User user = new User(name, email);
        User savedUser= userRepository.save(user);
        savedUser.setName("Case1Service");
    }
}
```

## âŒ ì¼€ì´ìŠ¤ 2: Private ë©”ì„œë“œ

### ë¬¸ì œê°€ ë˜ëŠ” ì½”ë“œ
```java
@Service
@RequiredArgsConstructor
@Slf4j
public class Case2Service {

    private final UserRepository userRepository;

    public void privateMethodExample() {
        this.updateUserPrivate();
        throw new RuntimeException("private Exception");
    }

    @Transactional  // âŒ private ë©”ì„œë“œëŠ” í”„ë¡ì‹œ ë¶ˆê°€!
    private void updateUserPrivate() {
        User newUser = new User("ë¡¤ë°±ë˜ì•¼í•  ìœ ì €", "temp@test.com");
        User savedUser= userRepository.save(newUser);
        savedUser.setName("Private");
    }
}
```

### ğŸ¤·â€â™‚ï¸ ì™œ ì•ˆë˜ë‚˜ìš”?
- í”„ë¡ì‹œëŠ” **public ë©”ì„œë“œ**ë§Œ ê°€ë¡œì±Œ ìˆ˜ ìˆìŒ
- private ë©”ì„œë“œëŠ” ì™¸ë¶€ì—ì„œ ì ‘ê·¼ ë¶ˆê°€í•˜ë¯€ë¡œ í”„ë¡ì‹œ ìƒì„± ë¶ˆê°€

## âŒ ì¼€ì´ìŠ¤ 3: Checked Exception

### ë¬¸ì œê°€ ë˜ëŠ” ì½”ë“œ

```java
@Slf4j
@RequiredArgsConstructor
@Service
public class Case3Service {

    private final UserRepository userRepository;

    @Transactional
    public void checkedExceptionExample() throws Exception {
        User newUser = new User("ë¡¤ë°±ë˜ì•¼í•  ìœ ì €", "temp@test.com");
        userRepository.save(newUser);
        throw new Exception("ì¡¸ë¦¬ë‹¤.");
    }
}
```

### ğŸ¤·â€â™‚ï¸ ì™œ ì•ˆë˜ë‚˜ìš”?
- Spring ê¸°ë³¸ ì„¤ì •: **RuntimeException**ë§Œ ë¡¤ë°±
- **Checked Exception**(Exception, IOException ë“±)ì€ ë¡¤ë°± ì•ˆë¨
- ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì—ì„œ ë³µêµ¬ ê°€ëŠ¥í•œ ì˜ˆì™¸ë¡œ ê°„ì£¼


## âŒ ì¼€ì´ìŠ¤ 4: í”„ë¡ì‹œ ë‚´ë¶€ì—ì„œ ìê¸° ìì‹  ë©”ì„œë“œ í˜¸ì¶œ

### ë¬¸ì œê°€ ë˜ëŠ” ì½”ë“œ
```java
@Service
@RequiredArgsConstructor
@Slf4j
public class Case4Service {

    private final UserRepository userRepository;

    @Transactional
    public void createMultipleUsers() {
        createSingleUser("í™ê¸¸ë™", "hong@test.com");
        createSingleUser("ê¹€ì² ìˆ˜", "invalid-email");
    }

    @Transactional(propagation = Propagation.REQUIRES_NEW)
    public void createSingleUser(String name, String email) throws RuntimeException {
        if (!email.contains("@")) {
            throw new RuntimeException("ì˜ëª»ëœ ì´ë©”ì¼");
        }

        User user = new User(name, email);
        userRepository.save(user);
    }
}
```

### ğŸ¤·â€â™‚ï¸ ì™œ ì•ˆë˜ë‚˜ìš”?
- `createSingleUser()` í˜¸ì¶œì´ í”„ë¡ì‹œë¥¼ ê±°ì¹˜ì§€ ì•ŠìŒ
- ë‚´ë¶€ì ìœ¼ë¡œëŠ” ëª¨ë‘ ê°™ì€ íŠ¸ëœì­ì…˜ì—ì„œ ì‹¤í–‰ë¨
- ê°œë³„ ë©”ì„œë“œì˜ `@Transactional` ì„¤ì •ì´ ë¬´ì‹œë¨

### âœ… í•´ê²° ë°©ë²•

**ë°©ë²• 1: ë³„ë„ ì„œë¹„ìŠ¤ ë¶„ë¦¬**
```java
@Service
public class UserService {
    @Autowired
    private UserCreationService userCreationService;
    
    @Transactional
    public void createMultipleUsers() {
        userCreationService.createSingleUser("í™ê¸¸ë™", "hong@test.com");
        userCreationService.createSingleUser("ê¹€ì² ìˆ˜", "kim@test.com");
    }
}

@Service
public class UserCreationService {
    @Autowired
    private UserRepository userRepository;
    
    @Transactional(propagation = Propagation.REQUIRES_NEW)  // ìƒˆ íŠ¸ëœì­ì…˜
    public void createSingleUser(String name, String email) {
        if (!email.contains("@")) {
            throw new RuntimeException("ì˜ëª»ëœ ì´ë©”ì¼");
        }
        
        User user = new User(name, email);
        userRepository.save(user);
    }
}
```

## ğŸ“Š ì •ë¦¬

| ì¼€ì´ìŠ¤ | ë¬¸ì œì  | í•´ê²°ë°©ë²• |
|--------|--------|----------|
| **Self-Invocation** | ê°™ì€ í´ë˜ìŠ¤ ë©”ì„œë“œ í˜¸ì¶œ | ë³„ë„ ì„œë¹„ìŠ¤ë¡œ ë¶„ë¦¬ |
| **Private ë©”ì„œë“œ** | í”„ë¡ì‹œ ìƒì„± ë¶ˆê°€ | publicìœ¼ë¡œ ë³€ê²½ |
| **Checked Exception** | ê¸°ë³¸ì ìœ¼ë¡œ ë¡¤ë°± ì•ˆë¨ | `rollbackFor` ëª…ì‹œ |
| **ë‚´ë¶€ ë©”ì„œë“œ í˜¸ì¶œ** | í”„ë¡ì‹œ ìš°íšŒ | ì„œë¹„ìŠ¤ ë¶„ë¦¬ + ì „íŒŒ ì„¤ì • |

## ğŸ¯ í•µì‹¬ í¬ì¸íŠ¸

1. **Spring BootëŠ” ìë™ìœ¼ë¡œ @Transactional ì§€ì›** - ë³„ë„ AOP ì„¤ì • ë¶ˆí•„ìš”
2. **í”„ë¡ì‹œ ê¸°ë°˜**ì´ë¯€ë¡œ ì™¸ë¶€ì—ì„œ í˜¸ì¶œë˜ì–´ì•¼ í•¨
3. **Public ë©”ì„œë“œ**ë§Œ ê°€ëŠ¥
4. **RuntimeException**ë§Œ ê¸°ë³¸ ë¡¤ë°±
5. ë³µì¡í•œ íŠ¸ëœì­ì…˜ ë¡œì§ì€ **ì„œë¹„ìŠ¤ë¥¼ ë¶„ë¦¬**í•˜ëŠ” ê²ƒì´ ì¢‹ìŒ
